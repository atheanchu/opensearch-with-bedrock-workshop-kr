# Hyrbid 검색이란?

하이브리드 검색은 키워드 검색과 Neural Search 검색을 결합하여 검색 관련성을 향상시킵니다. 하이브리드 검색을 구현하려면 검색 시간에 실행되는 [검색 파이프라인](https://opensearch.org/docs/latest/search-plugins/search-pipelines/index/)을 설정해야 합니다. 구성할 검색 파이프라인은 중간 단계에서 검색 결과를 가로채고 [`normalization_processor`](https://opensearch.org/docs/latest/search-plugins/search-pipelines/normalization-processor/)를 적용합니다. `normalization_processor`는 여러 쿼리 절에서의 문서 점수를 정규화하고 결합하여, 선택한 정규화 및 결합 기법에 따라 문서를 재점수화합니다.

## Prerequisite

이번 단계를 진행하기 위해서는 [시맨틱 검색 단계](https://www.notion.so/Semantic-Search-63ccc75ad5a4497394349e59f96c0e99?pvs=21)를 필수적으로 완료하셔야 합니다.

## 사전 준비

인덱스 생성과 데이터 적재는 이미 [시맨틱 검색 단계](https://www.notion.so/Semantic-Search-63ccc75ad5a4497394349e59f96c0e99?pvs=21)에서 완료 했습니다. Amazon OpenSearch Service로의 연결은 [시맨틱 검색 단계](https://www.notion.so/Semantic-Search-63ccc75ad5a4497394349e59f96c0e99?pvs=21)와 동일하게 수행합니다. 

# 하이브리드 검색 구현하기

```python
def hybrid_search(query_text):
    query = {
        "size": 10,
        "_source": {"exclude": ["vector_field"]},
        "query": {
            "hybrid": {
                "queries": [
                    {
                        "multi_match": {
                            "query": query_text,
                            "fields": ["title", "text", "genre"],
                        }
                    },
                    {
                        "neural": {
                            "vector_field": {
                                "query_text": query_text,
                                "model_id": model_id,
                                "k": 30,
                            }
                        }
                    },
                ]
            }
        },
        "search_pipeline": {
            "description": "Post processor for hybrid search",
            "phase_results_processors": [
                {
                    "normalization-processor": {
                        "normalization": {"technique": "min_max"},
                        "combination": {
                            "technique": "arithmetic_mean",
                            "parameters": {"weights": [0.3, 0.7]},
                        },
                    }
                }
            ],
        },
    }

    res = aos_client.search(index=index_name, body=query)

    query_result = []
    for hit in res["hits"]["hits"]:
        row = [
            hit["_id"],
            hit["_score"],
            hit["_source"]["title"],
            hit["_source"]["text"],
            hit["_source"]["genre"],
            hit["_source"]["rating"],
        ]
        query_result.append(row)

    query_result_df = pd.DataFrame(
        data=query_result, columns=["_id", "_score", "title", "text", "genre", "rating"]
    )
    display(query_result_df)
```

1. **`size`**: 검색 결과의 최대 개수를 10으로 설정합니다.
2. **`_source`**: 검색 결과에서 **`vector_field`** 필드를 제외합니다.
3. **`query`**:
    - **`hybrid`**: 하이브리드 검색을 수행합니다.
    - **`queries`**: 두 가지 검색 방식을 정의합니다.
        - **`multi_match`**: 전통적인 텍스트 기반 검색을 수행합니다. **`title`**, **`text`**, **`genre`** 필드에서 **`query_text`**를 검색합니다.
        - **`neural`**: 벡터 기반 검색을 수행합니다. **`vector_field`**에서 **`query_text`**와 유사한 벡터를 찾습니다. **`model_id`**는 사용할 모델을 지정하고, **`k`**는 최대 30개의 결과를 반환합니다.
4. **`search_pipeline`**:
    - **`description`**: 하이브리드 검색의 후처리를 설명합니다.
    - **`phase_results_processors`**:
        - **`normalization-processor`**:
            - **`normalization`**: 최소-최대 정규화 기법을 사용합니다.
            - **`combination`**:
                - **`technique`**: 가중 산술 평균을 사용하여 텍스트 기반 검색과 벡터 기반 검색 결과를 결합합니다.
                - **`parameters`**: 텍스트 기반 검색 결과에 0.3, 벡터 기반 검색 결과에 0.7의 가중치를 부여합니다.

# 검색 결과 비교

이전 단계에서 수행한 키워드 검색, 시맨틱 검색과 동일한 쿼리로 검색하여 결과를 비교해봅니다. 

```
query_text = "우주에서 벌어지는 전쟁"
```

## 키워드 기반 검색

TBD